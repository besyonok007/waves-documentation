# Конфигурация ноды

> После обновления до версии 1.0.2, обратите внимание, что если файл `/etc/waves/waves.conf` был изначально скопирован из шаблона, то нужно проверить, что параметр waves.directory задан для правильной папки. Если этой опции нет в конфигурационном файле, то папкой по умолчанию будет `/var/lib/waves` and `/var/lib/waves-testnet` для mainnet и testnet, соответственно.

## Формат конфигурации

В системе конфигурации ноды Waves применяется формат HOCON (Human-Optimized Config Object Notation). Подробное описание HOCON доступно по ссылке [Official HOCON documentation](https://github.com/typesafehub/config/blob/master/HOCON.md). Преимущества HOCON это просто синтаксис и возможность использовать комментарии.

## Стандартные файлы конфигурации и ручные настройки

### Стандартный файл конфигурации вложенный в JAR

Стандартный файл конфигурации ноды Waves, вложенный в файл jar-file доступен по [ссылке](https://github.com/wavesplatform/Waves/blob/master/node/src/main/resources/application.conf)

### Файлы конфигурации MainNet и TestNet в пакетах DEB

Установочные пакеты DEB содержат файлы конфигурации, которые переопределяют некоторые параметры, применяемые к сети:

* https://github.com/wavesplatform/Waves/blob/master/node/waves-mainnet.conf
* https://github.com/wavesplatform/Waves/blob/master/node/waves-testnet.conf

### Переопределение параметров при запуске файл JAR

При запуске файла JAR рекомендуется переопределять назначенные по умолчанию параметры вписав адрес файла конфигурации через командную строку при запуске приложения ноды Waves.

```
java -jar waves-all-0.13.3.jar waves.conf
```

Обычно в файле содержится информация об уникальных характеристиках вашей ноды (ip, имя, ключи,  и пр.) и параметры применяемые к сети, точно также как в файлах конфигурации waves-mainnet или waves-testnet из предыдущих секций (файлы из пакетов DEB).

## Секции конфигурации

### Секция конфигурации Waves

Root секция конфигурации waves содержит ключевые параметры и прочие конфигурационные подсекции.

С помощью параметра directory можно назначить путь к основной папке приложения. Начиная с версии 0.6.0 можно использовать переменные среды (environment variables) для настройки параметров конфигурации. Например, по умолчанию, параметр определяющий основную папку формируется относительно HOME - переменной среды пользователя. Пожалуйста не ставьте переменные среды в кавычки, в этом случае они будут обработаны как строки и не будут выполнены.

**Note:** Если вы хотите поменять папку waves в Ubuntu следует использовать параметр `-J-Dwaves.directory=path` in `/etc/waves/application.ini` and `/lib/systemd/system/waves.service`. Можно переназначить любой start JVM параметр в waves.service с приоритетом.

**Note:** Для пользователей Windows. Часто в Windows, переменная HOME environment не задана. Замените `${HOME}` на `${HOMEPATH}` или `${APPDATA}` в вашем дополнительном файле конфигурации. Также, не забывайте, что переменные среды Windows следует писать с учётом регистра.

Параметр `data-directory` задаёт расположение папки базы данных LevelDB.  В этой базе данных содержаться данные блокчейна и состояния.

Параметр `leveldb-cache-size` задаёт размер внутреннего кэша базы данных LevelDB.

**Note:** Убедитесь в том, что для заданной папки выбран правильный owner: `waves` для mainnet или `waves-testnet` для testnet.

**Note:** Для того, чтобы задать параметр размера кэша, нужно указать количество байтов. Можно использовать единицы измерения размера:

 <ul><li>K - килобайт</li><li>M - мегабайт</li><li>G - гигабайт</li></ul>

### Настройки сети

В секции `network` можно настроить параметры P2P сети.

Используйте параметр `file` чтобы задать расположение базы данных узлов. В этой базе данных хранится список известных и заблокированных узлов. По умолчанию, этот путь задан с учётом основной `directory` в секции `waves`.

Используйте параметр `declared-address` чтобы назначить внешний IP адрес и номер порта ноды. Это важно для работы NAT большинства облачных хостингов, где компьютер напрямую не взаимодействует с внешним адресом. Если не задать данный параметр, то нода сможет подключиться к P2P сети, но не сможет принимать входящие подключения, поэтому другие ноды не смогут подключиться. Другие ноды подключаются к Вашей ноде с помощью этих данных. Параметр следует задавать в формате "[ip-address]:[port]".

Используйте параметр `bind-address` чтобы назначить IP адрес локальной сети с которым будет взаимодействовать нода Waves для приёма подключений. По умолчанию нода связана с адресом `0.0.0.0` это означает, что она будет ожидать подключения от всех возможных сетевых адаптеров.

Используйте параметр `port` чтобы назначить номер сетевого порта, к которому будут подключаться другие ноды Waves. Убедитесь, что порт доступен из вне, иначе, Ваша нода будет подключаться к P2P сети только через исходящие подключения. Если порт используется другим приложением, нода не запуститься.

Параметр `node-name` можно использовать для того, чтобы назначить имя ноды, которое будет видно другим участникам P2P сети. Имя передаётся во время первоначального (handshake) обмена данными. По умолчанию этот параметр не задан, и имя генерируется случайным образом.

Параметр `nonce` передаётся во время первоначального (handshake) обмена данными. По умолчанию он не задан и генерируется случайным образом. Данный параметр используется для того, чтобы отличать ноды, подключенные с одного IP адреса.

Параметр `known-peers` используется для хранения списка (bootstrap) нод, с которыми Ваша нода будет устанавливать первоначальные исходящие соединения во время инициализации. По умолчанию заданы ноды Testnet.

Параметр `peers-data-residence-time` применяется чтобы задать интервал во время которого нода будет хранить информацию про внешние узлы с момента последней сессии подключения.

**Note:** Все параметры интервалов времени задаются в миллисекундах. Но можно использовать единицы измерения времени, чтобы сократить значения. Можно использовать следующие единицы измерения:

 <ul><li>s - секунда, секунды</li><li>m - минута, минуты</li><li>h - час, часы</li><li>d - день, дни</li></ul>

С примерами применения можно ознакомиться в стандартном конфигурационном файле выше.

Параметр `black-list-residence-time` применяется чтобы задать интервал в течении которого информация про внешний узел будет находиться в чёрном списке.

Параметр `max-inbound-connections` применяется чтобы задать максимальное количество одновременных входящих подключений к ноде.

Параметр `max-outbound-connections` применяется для ограничения количества исходящих сетевых подключений.

Параметр `max-single-host-connections` применяется чтобы задать разрешенное количество сетевых подключений с одного IP адреса.

Параметр `connection-timeout` применяется чтобы задать время таймаута сетевого подключения.

Параметр `outbound-buffer-size` применяется чтобы задать размер сетевого буфера. Лучше оставить значение по умолчанию. Неправильно заданный размер буфера может привести к неисправности ноды.

Параметр `max-unverified-peers` применяется чтобы изменить максимальный размер буфера для хранения информации об узлах, полученной во время первоначального (handshake) обмена данными.

Параметр `enable-peers-exchange` позволяет включить/выключить запрос и отправку информации про узлы.

Параметр `enable-blacklisting` позволяет включить/выключить черный список узлов.

Параметр `peers-broadcast-interval` позволяет задать интервал времени между сеансами передачи списков известных узлов другим нодам.

Параметр `handshake-timeout` позволяет задать время ожидания ответа во время первоначального (handshake) обмена данными. В случае отсутствия ответа, не ответивший узел попадёт в чёрный список.

В секции `upnp` можно задать настройки UPnP. Данные настройки нужны только в том случае, если, нода Waves запущена в домашней сети, где требуется настройка туннельного соединения роутера. По умолчанию, данная функциональность выключена. Используйте `enable` в секции `upnp` для включения.

В секции `traffic-logger` можно включить/выключить логирование некоторых исходящих или входящих сообщений. Сетевые сообщения логируются на уровне TRACE.



### Настройки кошелька

В секции `wallet` можно настроить встроенный в ноду кошелёк Waves.

Параметр `file` позволяет задать путь до файла кошелька. По умолчанию путь задан в соответствии с основной директорией приложения.

Параметр `password` позволяет задать пароль для файла кошелька.

Параметр `seed` позволяет пересоздать кошелёк на новой ноде. Вставьте Вашу BASE58 кодовую фразу (сид строку). Если у Вас нет кошелька, закомментируйте данный параметр и запустите ноду. Во время первого запуска, приложение создаст новый кошелёк со случайной кодовой фразой. В этом случае, кодовая фраза отобразится в логе приложения. Если Вы его потеряете или не хотите заглядывать в лог файл, кодовая фраза будет также доступна через REST API используя метод wallet/seed.

**Внимание:** Кошелёк это критически важный компонент Вашей ноды. Лучше всего хранить его файл в защищенном и безопасном месте. Не забудьте создать резервную копию файла Вашего кошелька. Рекомендуется удалить кодовую фразу из файла конфигурации сразу же после запуска ноды. Если злоумышленник получит доступ к Вашей секретной фразе, у него будет доступ ко всем вашим средствам на всех адресах!

#### Обновление настроек кошелька

Чтобы запустить ноду с другим кошельком, выполните следующее:

* удалите/перенесите файл wallet.dat чтобы папка /wallet стала пустой
* обновите кодовую фразу в файле конфигурации

После этого нода будет использовать настройки другого кошелька.

### Настройки блокчейна

В данной секции можно выбрать тип блокчейна или создать свой собственный блокчейн.

Параметр `max-transactions-per-block-diff` позволяет задать количество транзакций, которые будут храниться в памяти перед тем, как быть сохраненными на диске. Уменьшение этого значения может увеличить количество операций записи на диск.

Можно поменять количество блоков, которые будут храниться в памяти с помощью параметра `min-blocks-in-memory`.

Параметр `type` позволяет выбрать тип блокчейна. Доступные опции: TESTNET, MAINNET и CUSTOM. Для типов TESTNET и MAINNET, параметры блокчейна встроены в приложение, поэтому дополнительная настройка не требуется. При выборе блокчейн типа CUSTOM необходимо задать параметры секции custom (которая закомментирована в примере).

#### Настройка custom блокчейна

Параметр `address-scheme-character` в секции `custom` позволяет включить функцию address character. Символ, используется во время формирования адреса, а также передается по сети во время первичного (handshake) взаимодействия.

Секция `functionality` позволяет устанавливать временные отметки активации различных валидаций блокчейна. Лучше задать значение 0 для всех функциональностей, чтобы активировать все типы блокчейн валидации.

В секции `genesis` можно описать первый (genesis) блок Вашего кастомизированного блокчейна.

Параметр `block-timestamp` позволяет задать дату создания genesis блока. Параметр `timestamp` позволяет задать время создания genesis транзакций.

Параметр `signature` позволяет задать подпись genesis блока.

Параметр `initial-balance` позволяет задать общее количество монет. Это значение следует задавать в наименьших единицах измерения криптовалюты.

Параметр `initial-base-target` позволяет настроить скорость генерации блоков в самом начале Вашего кастомизированного блокчейна.

Параметр `average-block-delay` позволяет задать скорость генерации блоков Вашего блокчейна. Это будет установленный (к которому система будет стремиться) интервал времени между блоками, однако, на самом деле интервалы между блоками могут меняться.

В качества параметра `transactions` нужно задать список первых транзакций. Каждая транзакция должна содержать адрес получателя (строка BASE58) и количество. Необходимо распределить весь первоначальный баланс на один или несколько адресов genesis блока. Если этого не сделать, то genesis блок будет признана ошибочным и приложение не запустится.

### Настройки майнера

В секции `miner` можно настроить генератора новых блоков.

Параметр `enable` позволяет включить/выключить генерацию блоков для ноды. По умолчанию, генерация включена, но если её выключить, то нода не будет генерировать новые блоки.

Параметр `quorum` позволяет задать минимальное количество подключенных узлов, необходимых для майнинга новых блоков. По умолчанию задано значение 1, это означает, что Ваша нода начнёт майнинг сразу как только подключится к первому узлу P2P сети. Если задать значение 0, то активируется оффлайн генерация.

Параметр `interval-after-last-block-then-generation-is-allowed` позволяет настроить алгоритм поведения при загрузке и генерации блоков. По умолчанию задано значение 1 день, это означает, что Ваша нода не начнёт генерацию пока последний блок локального блокчейна будет не старше 1 дня. Используя данный параметр, Вы даёте команду ноде актуализировать блокчейн перед началом генерации новых блоков. Это применимо только после длительных отключений ноды.

### Настройки REST API

Секция REST API файла файла [node configuration file](https://confluence.wavesplatform.com/display/WDOCS/Node+configuration+file) с настройками [node API](/waves-node/node-api.md).

#### parameters

| # | Название | Описание | Значение по умолчанию |
| :--- | :--- | :--- | :--- |
| 1 | `enable` | Активирует REST API. <br>Для деактивации REST API, измените значение на `no` | yes |
| 2 | `bind-address` | Назначает сетевой адрес, по которому REST API будет принимать входящие подключения.<br>**Note:** Не рекомендуется менять значение по умолчанию. Используйте [Nginx’s proxy pass module](http://nginx.org/ru/docs/http/ngx_http_proxy_module.html) или [SSH port forwarding](http://blog.trackets.com/2014/05/17/ssh-tunnel-local-and-remote-port-forwarding-explained-with-examples.html) для внешнего доступа. | `"127.0.0.1"` |
| 3 | `port` | Назначает номер порта, через который REST API будет ожидать подключения. | 6869 |
| 4 | `api-key-hash` | Назначает хэш [API key](https://en.wikipedia.org/wiki/Application_programming_interface_key) который предоставляется владельцем ноды.<br> [API key](https://en.wikipedia.org/wiki/Application_programming_interface_key) владельца ноды очень важный параметр, также как и кодовая фраза [seed](http://confluence.wavesplatform.com/display/WDOCS/Seed+phrase) и пароль кошелька.<br>Выполните следующие шаги, для генерации хэша API key:<br> 1. Перейдите в [Swagger web interface](http://confluence.wavesplatform.com/display/WDOCS/Node+API)<br> 2. Нажмите на секцию [`utils`](https://nodes.wavesnodes.com/api-docs/index.html#/utils)section<br>3. Нажмите на API method [`/utils/hash/secure`](https://nodes.wavesnodes.com/api-docs/index.html#!/utils/hashSecure_1)<br>4. Создайте уникальную строку [API key](https://en.wikipedia.org/wiki/Application_programming_interface_key) и включите её в параметр `message`<br> 5. Скопируйте хэш [API key](https://en.wikipedia.org/wiki/Application_programming_interface_key) и вставьте его в Ваш файл конфигурации ноды<br>6. Перезапустите ноду<br>**Note:** PI key передаётся в заголовке HTTP как незащищенный plain текст. Злоумышленники могут перехватить его в процессе передачи по сети и использовать его чтобы перевести Ваши средства на любой адрес! Очень важно защитить передачу дынных с помощью HTTPS или SSH ретрансляции порта. | "" |
| 5 | cors | Включает поддержку [CORS](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing) которая важна для [Swagger](https://swagger.io/) и [DEX](http://confluence.wavesplatform.com/display/WDOCS/About+Waves+DEX). <br>[CORS](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing) позволяет безопасно получать запросы для других доменов, вне того, на котором работает нода.<br> **Note.** Для деактивации поддержки [CORS](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing), поменяйте значение на `no` | yes |

Во время запросов REST API владелец ноды должен предоставить уникальный [API key](https://en.wikipedia.org/wiki/Application_programming_interface_key) в виде строки, вместо хэш значения.
Пример подписи транзакции, которая уже существует в кошельке владельца ноды в виде CURL команды

```
curl -X POST --header 'Content-Type: application/json' --header 'Accept: application/json' --header 'X-API-Key: YOUR UNIQUE API KEY'
-d '{ \
amount: 5800000000, \
fee: 100000, \
type: 4, \
version: 1, \
attachment: "", \
sender: "3P3pUKEAKxegWr3PZkGYNq1mzQQaQ5zxZbw", \
feeAssetId: null, \ assetId: null, \
recipient: "3P9p39MwZ5JjwdBSYEWC6XYri4jpovzcAbs", \
feeAsset: null, \
timestamp: 1568020044350 \
}' 'http://nodes.wavesnodes.com/transactions/sign'
```

### Настройки синхронизации

В секции `synchronisation` можно настраивать различные аспекты процесса синхронизации ноды.

Параметр `max-rollback` позволяет задать количество блоков, которые будут сброшены в случае обнаружения форка. Если нода обнаружит форк с более низким score, она попытается переключиться на другой форк, для этого нода откатится на несколько блоков. Если обнаруженный форк длиннее заданного значения параметра, нода не не будет переключаться, даже если её score выше.

Параметр `max-chain-length` позволяет задать размер буфера для хранения блоков обнаруженного форка. Размер должен быть больше чем максимальная длина форка.

Параметр `synchronization-timeout` позволяет задать таймаут операции загрузки блока.

Параметр `score-broadcast-interval` позволяет задать интервал между публикациями score в P2P сети.

Параметр `score-ttl` позволяет задать интервал TTL (time-to-live) публикуемых пакетов score.

Параметр `remote-score-debounce` позволяет задать время ожидания до получения следующего обновления данных score от других узлов.

В подсекции `history-replier` можно задать количество последних блоков и микро-блоков, которые будут кешироваться в памяти.

В подсекции `micro-block-synchronizer` можно настроить различные параметры протокола Waves-NG.

### Настройки UTX pool

В данной секции, можно настроить размер пула неподтверждённых транзакций (параметр `max-size`) и максимальный допустимый UTX возраст транзакций (`max-transaction-age`).
